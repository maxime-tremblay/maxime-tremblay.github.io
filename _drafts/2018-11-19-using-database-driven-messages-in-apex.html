---
layout: post
title: Using Database Driven Messages in APEX
date: '2018-11-19T20:39:00.000-05:00'
author: Maxime Tremblay
tags: 
modified_time: '2018-11-19T20:39:14.283-05:00'
blogger_id: tag:blogger.com,1999:blog-267713902572011003.post-2152166547705602885
blogger_orig_url: https://max-tremblay.blogspot.com/2018/11/using-database-driven-messages-in-apex.html
---

Over time I've seen many solutions to have application use database driven messages in applications. Some were good and some were not.<br />At one of my previous client, we were asked to migrate applications overs to the Universal Theme (finally!).<br /><br />While at it, I looked at the solution they were using at the time and noticed that it was relying on a sync Ajax call. Bad bad bad!<br />So thought it was the perfect timing to replace all that with a better solution.<br /><br />The solution I ended up using relied on the same concept as what APEX is using. The idea is to generate and include a JavaScript file in the application that will contain all messages and that will be cached by the browser.<br /><br />If you want to have a look, here's the file APEX is using:<br />&lt;script src="wwv_flow.js_messages?p_app_id=42&amp;p_lang=en-us&amp;p_version=18.2.0.00.12-15344925320658"&gt;&lt;/script&gt;<br />&lt;script src="wwv_flow.js_messages?p_app_id=&lt;Application ID&gt;&amp;p_lang=&lt;Application language&gt;&amp;p_version=&lt;APEX Version - Timestamp&gt;"&gt;&lt;/script&gt;<br /><br />If we look at the content of that file, we can see that it's a call to the apex.lang.addMessages API (more information about it here: https://docs.oracle.com/database/apex-18.1/AEXJS/apex.lang.html#.addMessages).<br />Code:<br />apex.lang.addMessages({<br />"APEX.IG.X.DOES_NOT_START_WITH.Y":"\u00250 does not start with \u00251"<br />,"APEX.IG.PRIMARY_REPORT":"Primary Report"<br />,"APEX.RV.DUPLICATE":"Duplicate"<br />,"APEX.RV.REFRESH":"Refresh"<br />,"APEX.RV.REVERT":"Revert Changes"<br />,"APEX.IG.SHOW":"Show"<br />,"APEX.CLOSE_NOTIFICATION":"Close Notification"<br />,"FLOW.VALIDATION_ERROR":"\u00250 errors have occurred"<br /><br />...<br /><br />,"APEX.UI.BACK_TO_TOP":"Start of page"<br />});<br /><br /><br />Step 1. Let's create a database table that will store all of our messages:<br /><br />create table messages<br />(<br />&nbsp; id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; number&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; not null,<br />&nbsp; application_id&nbsp;&nbsp;&nbsp; number&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; not null,<br />&nbsp; name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; varchar2(255)&nbsp; not null,<br />&nbsp; message_language&nbsp; varchar2(50)&nbsp;&nbsp; not null,<br />&nbsp; message_text&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; varchar2(4000) not null,<br /><br />&nbsp; constraint messages_pk primary key (id)<br />)<br />;<br /><br />Note: For simplicity reasons audit columns, triggers and constraints were left out.<br /><br />Step 2. Create the procedure that will generate the JavaScript file<br /><br />/**<br />&nbsp;* Generates a JavaScript file including all application messages<br />&nbsp;*<br />&nbsp;* @example<br />&nbsp;* Include in an HTML script tag using<br />&nbsp;* app_messages_js?p_app_id=&amp;APP_ID.&amp;p_app_lang=&amp;.&amp;p_nuNo_Versn=#APEX_VERSION#<br />&nbsp;*<br />&nbsp;* @param p_app_id APEX application ID<br />&nbsp;* @param p_app_lang APEX application language<br />&nbsp;* @param p_version version identifier (used to reset the browser cached file )<br />&nbsp;*/<br />create or replace procedure app_messages_js(p_app_id in number,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; p_app_lang in varchar2,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; p_version in varchar2 default null)<br />is<br />&nbsp;&nbsp; l_msg_count number := 0;<br /><br />&nbsp;&nbsp; cursor cur_mesg is<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select name,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; message_text<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; from messages<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; where application_id = p_app_id<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and message_language = p_app_lang;<br />begin<br />&nbsp;&nbsp; --header<br />&nbsp;&nbsp; sys.owa_util.mime_header(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ccontent_type =&gt; 'text/javascript',<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bclose_header =&gt; false );<br />&nbsp;&nbsp; sys.owa_util.http_header_close;<br /><br />&nbsp;&nbsp; --content<br />&nbsp;&nbsp; for rec_mesg in cur_mesg<br />&nbsp;&nbsp; loop<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if l_msg_count = 0 then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.htp.p( 'apex.lang.addMessages({' );<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.htp.prn( ',' );<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end if;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.htp.p(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; apex_javascript.add_attribute(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; p_name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; =&gt; rec_mesg.name,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; p_value&nbsp;&nbsp;&nbsp;&nbsp; =&gt; rec_mesg.message_text,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; p_omit_null =&gt; false,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; p_add_comma =&gt; false));<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; l_msg_count := l_msg_count + 1;<br />&nbsp;&nbsp; end loop;<br /><br />&nbsp;&nbsp; if l_msg_count &gt; 0 then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sys.htp.p( '});' );<br />&nbsp;&nbsp; end if;<br />end app_messages_js;<br /><br />Step 3. Add grant and create synonym<br /><br />grant execute on app_messages_js to "public";<br />create or replace public synonym app_messages_js for app_messages_js;<br /><br />Step 4. Integrate the above procedure in our application<br /><br />In the Desktop User Interface of our application's Shared Components, we are able to directly add/integrate our procedure <br />Depending on how your application language is derived (in the globalizations properties), use one of the following:<br /><br />app_messages_js?p_app_id=&amp;APP_ID.&amp;p_app_lang=&amp;BROWSER_LANGUAGE.-&amp;p_version=#APEX_VERSION#<br /><br />app_messages_js?p_app_id=&amp;APP_ID.&amp;p_app_lang=&amp;FSP_LANGUAGE_PREFERENCE.-&amp;p_version=#APEX_VERSION#<br /><br />app_messages_js?p_app_id=&amp;APP_ID.&amp;p_app_lang=&amp;G_APP_LANG.-&amp;p_version=#APEX_VERSION#<br /><br />Step 5. Enable the procedure to be called directly <br /><br />For this we need to add our procedure name to the whitelist in wwv_flow_epg_include_mod_local in the APEX's schema.<br /><br />CREATE OR REPLACE function APEX_050100.wwv_flow_epg_include_mod_local(<br />&nbsp;&nbsp;&nbsp; procedure_name in varchar2)<br />return boolean<br />is<br />begin<br />&nbsp;&nbsp;&nbsp; -- return false; -- remove this statement when you modify this function<br />&nbsp;&nbsp;&nbsp; --<br />&nbsp;&nbsp;&nbsp; -- Administrator note: the procedure_name input parameter may be in the format:<br />&nbsp;&nbsp;&nbsp; --<br />&nbsp;&nbsp;&nbsp; --&nbsp;&nbsp;&nbsp; procedure<br />&nbsp;&nbsp;&nbsp; --&nbsp;&nbsp;&nbsp; schema.procedure<br />&nbsp;&nbsp;&nbsp; --&nbsp;&nbsp;&nbsp; package.procedure<br />&nbsp;&nbsp;&nbsp; --&nbsp;&nbsp;&nbsp; schema.package.procedure<br />&nbsp;&nbsp;&nbsp; --<br />&nbsp;&nbsp;&nbsp; -- If the expected input parameter is a procedure name only, the IN list code shown below<br />&nbsp;&nbsp;&nbsp; -- can be modified to itemize the expected procedure names. Otherwise you must parse the<br />&nbsp;&nbsp;&nbsp; -- procedure_name parameter and replace the simple code below with code that will evaluate<br />&nbsp;&nbsp;&nbsp; -- all of the cases listed above.<br />&nbsp;&nbsp;&nbsp; --<br />&nbsp;&nbsp;&nbsp; if upper(procedure_name) in (<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 'F101000_PR_APEX_GENR_MESG_JS'<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ) then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return TRUE;<br />&nbsp;&nbsp;&nbsp; else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return FALSE;<br />&nbsp;&nbsp;&nbsp; end if;<br />end wwv_flow_epg_include_mod_local;<br />/<br /><br />Now that we have everything backend related is in place, we'll need to have a way to call/include mesasges from the database in our applications.<br />Let's create/add the following JavaScript code:<br />/*******************************************************************************<br />&nbsp;*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Registre des modifications<br />&nbsp;* Date&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Nom&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Description<br />&nbsp;* 2018-03-06&nbsp;&nbsp;&nbsp;&nbsp; Maxime Tremblay&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Cr√©ation initiale<br />&nbsp;******************************************************************************/<br /><br />/*******************************************************************************<br />&nbsp;* Initialiser la variable de namespace app.message<br />&nbsp;******************************************************************************/<br />var app = app||{};<br />app.message = {};<br /><br />(function(message, app, ut, $) {<br />&nbsp;&nbsp; "use strict";<br /><br />&nbsp;&nbsp; /**<br />&nbsp;&nbsp;&nbsp; * Constants<br />&nbsp;&nbsp;&nbsp; */<br />&nbsp;&nbsp; var APEX_SUCCESS_MESSAGE = "#APEX_SUCCESS_MESSAGE";<br /><br />&nbsp;&nbsp; //Fonction permettant de r√©cup√©rer un message et d'effectuer le remplacement des variables du messages<br />&nbsp;&nbsp; message.getMessage = function (p_msg_name) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // obtenir le messsage (%0)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var mesg = apex.lang.getMessage(p_msg_name),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; args = [ mesg ].concat( Array.prototype.slice.call( arguments, 1 )); //<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //dynamic signature function call according to the number of parameters<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return apex.lang.format.apply( this, args );<br />&nbsp;&nbsp; };<br /><br />&nbsp;&nbsp; //Fonction priv√© pour afficher les messages<br />&nbsp;&nbsp; // l'affichage se fait sur les √©l√©ments HTML avec la classe "has-dbMessage"<br />&nbsp;&nbsp; // les variables de remplacements des messages doivent √™tre ajout√© dans les attributs data-paramX (ou X est le num√©ro de la variable)<br />&nbsp;&nbsp; // ex : &lt;span class="has-dbMessage" data-msg_name="101001"&gt;&lt;/span&gt;<br />&nbsp;&nbsp; //&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;span class="has-dbMessage" data-msg_name="101001" data-param0="test"&gt;&lt;/span&gt;<br />&nbsp;&nbsp; function _showMessage () {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $('.has-dbMessage:not(.is-msgRendered)').each(function(){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var this$ = $(this),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; l_msg_name = this$.data('msg_name'),<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; l_parmt = [],<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; l_reg_exp = /^(param)(\d)$/i;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //r√©cup√©rer les variables de remplacement<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $.each(this$.data(), function (i, e){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //utiliser seulement les data en lien avec les variables de remplacement<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (l_reg_exp.test(i)){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var index = i.replace(l_reg_exp, '$2');<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; l_parmt[index] = e;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; });<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var args = [ l_msg_name ].concat(l_parmt);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var mesg = message.getMessage.apply( this, args );<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this$.html(mesg)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .addClass('is-msgRendered');<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; });<br />&nbsp;&nbsp; }<br /><br />&nbsp;&nbsp; //On page load<br />&nbsp;&nbsp; $( document ).ready( function() {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Show messages on page load<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // -success messages (when using "Always Reload" or "Reload Only for Sucess")<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // -error messages (when using "Always Reload")<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _showMessage();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //For dynamic message using the JS APIs<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; var msg$ = $( APEX_SUCCESS_MESSAGE );<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; apex.message.setThemeHooks( {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; beforeHide: function( pMsgType ){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ( pMsgType === apex.message.TYPE.SUCCESS ) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; msg$.addClass( 'animate-hide' );<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; beforeShow: function( pMsgType ){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Show messages<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // -success messages (when using JS APIs)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // -error messages (when using "Reload Only for Sucess")<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _showMessage();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; });<br />&nbsp;&nbsp; });<br /><br />})(app.message, app, apex.theme42, apex.jQuery);<br /><br /><br />